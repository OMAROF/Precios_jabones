<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios para Jabones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #10b981;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
         .btn-download {
            background-color: #3b82f6;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-download:hover {
            background-color: #2563eb;
        }
        .btn-neutral {
            background-color: #6b7280;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-neutral:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px #c7d2fe;
        }
        .table-header {
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .summary-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Calculadora de Costos de Jabones</h1>
            <p class="mt-2 text-lg text-gray-600">Calcula el costo de producción y el precio de venta de tus jabones artesanales.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
            <!-- Columna Izquierda: Ingredientes y Receta -->
            <div>
                 <!-- Sección para Información de la receta -->
                 <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Información de la Receta</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="receta-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Receta</label>
                            <input type="text" id="receta-nombre" placeholder="Ej: Jabón de Avena y Miel" class="input-field">
                        </div>
                        <div>
                            <label for="receta-caracteristicas" class="block text-sm font-medium text-gray-700 mb-1">Características</label>
                            <textarea id="receta-caracteristicas" rows="2" placeholder="Ej: Exfoliante y humectante" class="input-field"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sección para agregar ingredientes -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Paso 1: Agrega los Ingredientes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="ingrediente" class="block text-sm font-medium text-gray-700 mb-1">Ingrediente</label>
                            <select id="ingrediente" class="input-field"></select>
                        </div>
                        <div>
                            <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad (g/ml)</label>
                            <input type="number" id="cantidad" placeholder="Ej: 100" class="input-field">
                        </div>
                        <div class="md:col-span-2">
                            <button id="agregar-btn" class="btn-primary w-full">Agregar a la Receta</button>
                        </div>
                    </div>
                </div>

                <!-- Sección de la receta actual -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Paso 2: Revisa tu Receta</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Ingrediente</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Cant.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">%</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Costo</th>
                                    <th class="relative px-4 py-3"><span class="sr-only">Eliminar</span></th>
                                </tr>
                            </thead>
                            <tbody id="lista-receta" class="bg-white divide-y divide-gray-200">
                                <tr id="fila-vacia-receta">
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Aún no has agregado ingredientes.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Gastos y Precio Final -->
            <div>
                <!-- Sección para gastos adicionales -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Paso 3: Agrega Gastos Adicionales</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="gasto-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <input type="text" id="gasto-descripcion" placeholder="Ej: Etiquetas" class="input-field">
                        </div>
                        <div>
                            <label for="gasto-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto ($)</label>
                            <input type="number" id="gasto-monto" placeholder="Ej: 15" class="input-field">
                        </div>
                        <div class="md:col-span-2">
                             <button id="agregar-gasto-btn" class="btn-secondary w-full">Agregar Gasto</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full divide-y divide-gray-200">
                             <thead class="table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Descripción</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Monto</th>
                                    <th class="relative px-4 py-3"><span class="sr-only">Eliminar</span></th>
                                </tr>
                            </thead>
                            <tbody id="lista-gastos" class="bg-white divide-y divide-gray-200">
                                <tr id="fila-vacia-gastos">
                                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">Aún no has agregado gastos.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sección de cálculo de precio final -->
                <div class="card">
                     <h2 class="text-xl font-semibold mb-4">Paso 4: Calcula el Precio Final</h2>
                     <div>
                        <label for="ganancia" class="block text-sm font-medium text-gray-700">Margen de Ganancia (%)</label>
                        <p class="text-xs text-gray-500 mb-1">¿Qué porcentaje quieres ganar sobre el costo total?</p>
                        <input type="number" id="ganancia" value="30" class="input-field mb-6">
                    </div>
                    <div class="summary-card space-y-4">
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-600">Costo Ingredientes:</p>
                            <p id="costo-total-ingredientes" class="text-lg font-semibold text-gray-900">$0.00</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-600">Costo Gastos Adicionales:</p>
                            <p id="costo-total-gastos" class="text-lg font-semibold text-gray-900">$0.00</p>
                        </div>
                         <div class="flex justify-between items-center text-green-600">
                            <p class="text-sm font-medium">Ganancia Estimada:</p>
                            <p id="ganancia-estimada" class="text-lg font-semibold">$0.00</p>
                        </div>
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <p class="text-sm font-semibold text-indigo-600">PRECIO DE VENTA SUGERIDO:</p>
                            <p id="precio-final" class="text-4xl font-extrabold text-indigo-700">$0.00</p>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-[-1rem]">
                    <button id="nuevo-registro-btn" class="btn-neutral w-full sm:w-auto">Nuevo Registro</button>
                    <button id="descargar-reporte-btn" class="btn-download w-full sm:w-auto">Descargar Reporte en PDF</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let productos = [];
            let receta = [];
            let gastosAdicionales = [];

            const inputRecetaNombre = document.getElementById('receta-nombre');
            const inputRecetaCaracteristicas = document.getElementById('receta-caracteristicas');
            const btnDescargarReporte = document.getElementById('descargar-reporte-btn');
            const btnNuevoRegistro = document.getElementById('nuevo-registro-btn');

            const selectorIngrediente = document.getElementById('ingrediente');
            const inputCantidad = document.getElementById('cantidad');
            const btnAgregar = document.getElementById('agregar-btn');
            const listaReceta = document.getElementById('lista-receta');
            const filaVaciaReceta = document.getElementById('fila-vacia-receta');
            
            const inputGastoDescripcion = document.getElementById('gasto-descripcion');
            const inputGastoMonto = document.getElementById('gasto-monto');
            const btnAgregarGasto = document.getElementById('agregar-gasto-btn');
            const listaGastos = document.getElementById('lista-gastos');
            const filaVaciaGastos = document.getElementById('fila-vacia-gastos');

            const inputGanancia = document.getElementById('ganancia');
            const elCostoTotalIngredientes = document.getElementById('costo-total-ingredientes');
            const elCostoTotalGastos = document.getElementById('costo-total-gastos');
            const elGananciaEstimada = document.getElementById('ganancia-estimada');
            const elPrecioFinal = document.getElementById('precio-final');

            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    productos = data;
                    inicializarAplicacion();
                });

            function inicializarAplicacion() {
                productos.forEach(producto => {
                    const option = document.createElement('option');
                    option.value = producto.nombre;
                    option.textContent = `${producto.nombre} ($${producto.precio_por_gramo.toFixed(2)} por g/ml)`;
                    selectorIngrediente.appendChild(option);
                });

                renderizarReceta();
                renderizarGastos();
            }

            function renderizarReceta() {
                listaReceta.innerHTML = '';
                const baseGlicerina = receta.find(item => item.nombre === "Base_Jabon Variados");
                const cantidadBase = baseGlicerina ? baseGlicerina.cantidad : 0;

                if (receta.length === 0) {
                    listaReceta.appendChild(filaVaciaReceta);
                } else {
                    receta.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        let porcentajeContenido = (item.nombre === 'Base_Jabon Variados') ? `<div class="text-sm font-semibold text-indigo-600">Base</div>`
                            : (cantidadBase > 0) ? `<div class="text-sm text-gray-700">${((item.cantidad / cantidadBase) * 100).toFixed(2)}%</div>`
                            : `<div class="text-sm text-gray-500">N/A</div>`;
                        
                        tr.innerHTML = `
                            <td class="px-4 py-2"><div class="text-sm font-medium text-gray-900">${item.nombre}</div></td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">${item.cantidad} g/ml</div></td>
                            <td class="px-4 py-2">${porcentajeContenido}</td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">$${item.costo.toFixed(2)}</div></td>
                            <td class="px-4 py-2 text-right"><button class="btn-danger btn-sm" data-index="${index}">X</button></td>`;
                        listaReceta.appendChild(tr);
                    });
                }
                calcularTotales();
            }

            function renderizarGastos() {
                listaGastos.innerHTML = '';
                if (gastosAdicionales.length === 0) {
                    listaGastos.appendChild(filaVaciaGastos);
                } else {
                    gastosAdicionales.forEach((gasto, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-4 py-2"><div class="text-sm font-medium text-gray-900">${gasto.descripcion}</div></td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">$${gasto.monto.toFixed(2)}</div></td>
                            <td class="px-4 py-2 text-right"><button class="btn-danger btn-sm" data-index="${index}">X</button></td>`;
                        listaGastos.appendChild(tr);
                    });
                }
                calcularTotales();
            }
            
            function calcularTotales() {
                const costoIngredientes = receta.reduce((total, item) => total + item.costo, 0);
                const costoGastos = gastosAdicionales.reduce((total, gasto) => total + gasto.monto, 0);
                
                elCostoTotalIngredientes.textContent = `$${costoIngredientes.toFixed(2)}`;
                elCostoTotalGastos.textContent = `$${costoGastos.toFixed(2)}`;

                const margenGanancia = parseFloat(inputGanancia.value) || 0;
                const costoProduccionTotal = costoIngredientes + costoGastos;
                const gananciaCalculada = costoProduccionTotal * (margenGanancia / 100);
                const precioVenta = costoProduccionTotal + gananciaCalculada;
                
                elGananciaEstimada.textContent = `$${gananciaCalculada.toFixed(2)}`;
                elPrecioFinal.textContent = `$${precioVenta.toFixed(2)}`;
            }

            btnAgregar.addEventListener('click', () => {
                const nombreIngrediente = selectorIngrediente.value;
                const cantidad = parseFloat(inputCantidad.value);
                if (!cantidad || cantidad <= 0) return;

                const producto = productos.find(p => p.nombre === nombreIngrediente);
                receta.push({ nombre: nombreIngrediente, cantidad, costo: producto.precio_por_gramo * cantidad });
                
                inputCantidad.value = '';
                renderizarReceta();
            });

            btnAgregarGasto.addEventListener('click', () => {
                const descripcion = inputGastoDescripcion.value.trim();
                const monto = parseFloat(inputGastoMonto.value);
                if (!descripcion || !monto || monto <= 0) return;

                gastosAdicionales.push({ descripcion, monto });
                
                inputGastoDescripcion.value = '';
                inputGastoMonto.value = '';
                renderizarGastos();
            });

            listaReceta.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    receta.splice(e.target.dataset.index, 1);
                    renderizarReceta();
                }
            });

            listaGastos.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    gastosAdicionales.splice(e.target.dataset.index, 1);
                    renderizarGastos();
                }
            });

            btnNuevoRegistro.addEventListener('click', () => {
                receta = [];
                gastosAdicionales = [];
                inputRecetaNombre.value = '';
                inputRecetaCaracteristicas.value = '';
                inputGastoDescripcion.value = '';
                inputGastoMonto.value = '';
                inputCantidad.value = '';
                inputGanancia.value = '30';
                renderizarReceta();
                renderizarGastos();
            });

            btnDescargarReporte.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const nombreReceta = inputRecetaNombre.value.trim() || 'Receta Sin Nombre';
                const caracteristicas = inputRecetaCaracteristicas.value.trim();
                const baseGlicerina = receta.find(item => item.nombre === "Base_Jabon Variados");
                const cantidadBase = baseGlicerina ? baseGlicerina.cantidad : 0;

                let y = 15;
                const lineHeight = 7;
                const margin = 15;

                doc.setFontSize(18);
                doc.text("REPORTE DE COSTOS DE PRODUCTO", margin, y);
                y += lineHeight * 2;

                doc.setFontSize(12);
                doc.text(`Nombre: ${nombreReceta}`, margin, y);
                y += lineHeight;
                if(caracteristicas) {
                    doc.text(`Características: ${caracteristicas}`, margin, y);
                    y += lineHeight;
                }
                y += lineHeight;

                doc.setFontSize(14);
                doc.text("--- INGREDIENTES ---", margin, y);
                y += lineHeight;
                doc.setFontSize(10);
                receta.forEach(item => {
                    let porcentaje = '';
                     if (item.nombre === 'Base_Jabon Variados') {
                        porcentaje = ` (Base)`;
                    } else if (cantidadBase > 0) {
                        porcentaje = ` (${((item.cantidad / cantidadBase) * 100).toFixed(2)}%)`;
                    }
                    const line = `- ${item.nombre}: ${item.cantidad} g/ml${porcentaje} -> $${item.costo.toFixed(2)}`;
                    doc.text(line, margin, y);
                    y += lineHeight;
                });
                y += lineHeight;
                
                doc.setFontSize(14);
                doc.text("--- GASTOS ADICIONALES ---", margin, y);
                y += lineHeight;
                doc.setFontSize(10);
                if (gastosAdicionales.length > 0) {
                    gastosAdicionales.forEach(gasto => {
                         const line = `- ${gasto.descripcion}: $${gasto.monto.toFixed(2)}`;
                         doc.text(line, margin, y);
                         y += lineHeight;
                    });
                } else {
                    doc.text("(Ninguno)", margin, y);
                    y += lineHeight;
                }
                y += lineHeight;

                doc.setFontSize(14);
                doc.text("--- RESUMEN DE COSTOS Y PRECIO ---", margin, y);
                y += lineHeight;
                doc.setFontSize(11);
                doc.text(`Costo de Ingredientes: ${elCostoTotalIngredientes.textContent}`, margin, y);
                y += lineHeight;
                doc.text(`Costo de Gastos Adicionales: ${elCostoTotalGastos.textContent}`, margin, y);
                y += lineHeight;
                doc.setTextColor(34, 139, 34); // Color verde
                doc.text(`Ganancia Estimada (${inputGanancia.value}%): ${elGananciaEstimada.textContent}`, margin, y);
                doc.setTextColor(0, 0, 0); // Reset color a negro
                y += lineHeight * 1.5;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`PRECIO DE VENTA SUGERIDO: ${elPrecioFinal.textContent}`, margin, y);

                const nombreArchivo = `reporte_costos_${nombreReceta.replace(/ /g, '_').toLowerCase()}.pdf`;
                doc.save(nombreArchivo);
            });
            
            inputGanancia.addEventListener('input', calcularTotales);
        });
    </script>
</body>
</html>